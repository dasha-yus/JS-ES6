<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>16_2</title>
	<link rel="stylesheet" href="css/game.css">
	<script src="js/chapter/16_game.js"></script>
	<script src="js/levels.js"></script>
</head>
<body>
	<script>
  		function runLevel(level, Display) {
    		let display = new Display(document.body, level);
    		let state = State.start(level);
    		let ending = 1;
    		var running = true;
    		return new Promise(resolve => {
      			function escHandler(event) {
        			if (event.key != "Escape") return;
        			event.preventDefault();
        			if (running == false) {
          				running = true;
         	 			runAnimation(frame);
        			} else if (running == true) {
          				running = "pausing";
        			} else {
          				running = true;
        			}
      			}

      			window.addEventListener("keydown", escHandler);
      			var arrowKeys = trackKeys(["ArrowLeft", "ArrowRight", "ArrowUp"]);

      			function frame(time) {
        			if (running == "pausing") {
          				running = false;
          				return false;
        			}

        			state = state.update(time, arrowKeys);
        			display.syncState(state);
        			if (state.status == "playing") {
         	 			return true;
        			} else if (ending > 0) {
          				ending -= time;
          				return true;
        			} else {
          				display.clear();
          				window.removeEventListener("keydown", escHandler);
          				arrowKeys.unregister();
          				resolve(state.status);
          				return false;
        			}
      			}
      			runAnimation(frame);
    		});
  		}

  		function trackKeys(keys) {
    		var down = Object.create(null);
    		function track(event) {
      			if (keys.includes(event.key)) {
        			down[event.key] = event.type == "keydown";
        			event.preventDefault();
      			}
    		}
    		window.addEventListener("keydown", track);
    		window.addEventListener("keyup", track);
    		down.unregister = () => {
     			window.removeEventListener("keydown", track);
      			window.removeEventListener("keyup", track);
    		};
    		return down;
  		}

  		runGame(GAME_LEVELS, DOMDisplay);
	</script>
</body>
</html>